<script>
import '~/assets/css/main.css';

const map = document.querySelector('#map');
const canvas = document.querySelector('canvas');
const playerList = document.querySelector('#player-list');
const statusIndicator = document.querySelector('#status-indicator');
const statusText = statusIndicator.querySelector('#status');
const debugText = document.querySelector('#debug');
const statsTable = document.querySelector('#stats-table');
const clearButton = document.querySelector('#clear-cache');

const socket = new ReconnectingWebSocket(`wss://${location.host}/ws`);

fetch('/api/servers/')
	.then((response) => response.json())
	.then((data) => {
		players.clear();
		data.forEach((server) => {
			server.players.forEach((player) => {
				if (document.querySelector(`#player-pin-${player.userId}`)) {
					players.update(player);
				} else {
					players.add(player);
				}
			});
		});
	});

socket.addEventListener('open', (_event) => {
	statusIndicator.classList = 'status-indicator connected';
	statusText.innerHTML = `Connected`;
});

socket.addEventListener('error', (event) => {
	statusIndicator.classList = 'status-indicator error';
	statusText.innerHTML = `Connection error: <code>${JSON.stringify(event, null, 1)}</code>`;
});

socket.addEventListener('message', (event) => {
	const data = JSON.parse(event.data);
	// debugText.textContent = JSON.stringify(data, null, 3);
	console.log('Message', data);

	switch (data.type) {
		case 'playerAdded':
			players.add(data.data);
			break;
		case 'playerUpdated':
			players.update(data.data);
			break;
		case 'playerDeleted':
			players.delete(data.data);
			break;
		case 'statsUpdated':
			statsTable.querySelector('#viewers').textContent = data.data.stats.viewers;
			statsTable.querySelector('#average-ping').textContent = `${data.data.stats.averagePing}ms`;
			statsTable.querySelector('#server-fps').textContent = data.data.stats.serverFps;
			statsTable.querySelector('#server-location').textContent = data.data.stats.serverLocation;
			break;
	}
});

let playerCount = 0;
const players = {
	add: async (data) => {
		// add to player list
		const playerItem = playerList.querySelector('#player-template').cloneNode(true);
		playerItem.id = `player-${data.userId}`;
		playerItem.title = `User ID: ${data.userId}`;
		playerItem.querySelector('#player-display-name').textContent = data.displayName;
		playerItem.querySelector('#player-username').textContent = data.username;
		playerItem.hidden = null;
		playerItem.querySelector('img').src = `/api/headshot/${data.userId}?size=100`;
		playerList.appendChild(playerItem);

		// add to map
		const playerPin = document.createElement('img');
		playerPin.src = `/api/headshot/${data.userId}?size=100`;
		playerPin.className = 'player-pin';
		playerPin.id = `player-pin-${data.userId}`;
		playerPin.style.backgroundColor = `#${Math.floor(Math.random() * 16777215).toString(16)}`;
		playerPin.style.translate = `${data.data.position.x + 15}px ${data.data.position.y + 15}px`;
		playerPin.style.rotate = `${data.data.rotation.y}deg`;
		map.appendChild(playerPin);

		// update stats
		playerCount++;
		statsTable.querySelector('#players').textContent = playerCount;
	},
	update: (data) => {
		// update player pin
		const playerPin = document.querySelector(`#player-pin-${data.userId}`);
		if (!playerPin) {
			console.error('Player pin not found');
			return;
		}
		playerPin.style.translate = `${data.data.position.x + 15}px ${data.data.position.y + 15}px`;
		playerPin.style.rotate = `${data.data.rotation.y}deg`;
	},
	delete: (data) => {
		// delete player item
		const playerItem = document.querySelector(`#player-${data.userId}`);
		if (!playerItem) {
			console.error('Player item not found');
			return;
		}
		playerItem.remove();

		// delete player pin
		const playerPin = document.querySelector(`#player-pin-${data.userId}`);
		if (!playerPin) {
			console.error('Player pin not found');
			return;
		}
		playerPin.remove();

		playerCount--;
		statsTable.querySelector('#players').textContent = playerCount;
	},
	clear: () => {
		document.querySelectorAll('.player:not(#player-template)').forEach((playerItem) => playerItem.remove());
		document.querySelectorAll('.player-pin').forEach((pin) => pin.remove());

		playerCount = 0;
		statsTable.querySelector('#players').textContent = playerCount;
	},
};

clearButton.addEventListener('click', players.clear);
</script>

<template>
	<div id="map">
		<svg width="100%" height="100%" xmlns="http://www.w3.org/2000/svg">
			<defs>
				<pattern id="smallGrid" width="10" height="10" patternUnits="userSpaceOnUse">
					<path d="M 10 0 L 0 0 0 10" fill="none" stroke="gray" stroke-width="0.5" />
				</pattern>
				<pattern id="grid" width="100" height="100" patternUnits="userSpaceOnUse">
					<rect width="100" height="100" fill="url(#smallGrid)" />
					<path d="M 100 0 L 0 0 0 100" fill="none" stroke="gray" stroke-width="1" />
				</pattern>
			</defs>

			<rect width="100%" height="100%" rx="12" fill="url(#smallGrid)" />
		</svg>
		<!-- <div id="spawn" style="translate: 0px 0px;"></div> -->
	</div>
	<aside>
		<section class="status">
			<h2>Status</h2>

			<div id="status-indicator" class="status-indicator connecting">
				<svg height="16" width="16" xmlns="http://www.w3.org/2000/svg">
					<circle r="8" cx="8" cy="8" fill="currentColor" />
				</svg>
				<span id="status">Connecting...</span>
			</div>

			<table id="stats-table">
				<tr>
					<td>Players</td>
					<td id="players">...</td>
				</tr>
				<tr>
					<td>Viewers</td>
					<td id="viewers">...</td>
				</tr>
				<tr>
					<td>Average Ping</td>
					<td id="average-ping">...</td>
				</tr>
				<tr>
					<td>Server FPS</td>
					<td id="server-fps">...</td>
				</tr>
				<tr>
					<td>Server Location</td>
					<td id="server-location">...</td>
				</tr>
			</table>
		</section>

		<section class="players">
			<h2>Players</h2>

			<ul id="player-list">
				<li class="player" id="player-template" hidden>
					<img src="/placeholder.png" class="avatar" />
					<span id="player-display-name"></span> <span id="player-username"></span>
				</li>
			</ul>
		</section>
		<button id="clear-cache">Clear Cache</button>
		<div id="debug"></div>
	</aside>
</template>
